<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta name="generator" content="Hugo 0.101.0" />
  <meta charset="utf-8">
  <title>net/rpc · Yehh</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="net/rpc 简介: 远程过程调用 (Remote Procedure Call，RPC) 是一种计算机通信协议。允许运行在一台计算机的程序调用另一个地址空间的子程序（一般是开放网络中的一台" />

  <meta name="keywords" content="Hugo, theme, den" />

<link rel="canonical" href="https://blog.yehaohui.com/zh-cn/2023/02/25/category/net/rpc/" />

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
<link rel="stylesheet" href="https://blog.yehaohui.com/css/den.css">




<meta property="og:title" content="net/rpc" />
<meta property="og:description" content="net/rpc 简介: 远程过程调用 (Remote Procedure Call，RPC) 是一种计算机通信协议。允许运行在一台计算机的程序调用另一个地址空间的子程序（一般是开放网络中的一台" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.yehaohui.com/zh-cn/2023/02/25/category/net/rpc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-25T09:01:23+08:00" />
<meta property="article:modified_time" content="2023-11-25T09:20:30+08:00" />

<meta itemprop="name" content="net/rpc">
<meta itemprop="description" content="net/rpc 简介: 远程过程调用 (Remote Procedure Call，RPC) 是一种计算机通信协议。允许运行在一台计算机的程序调用另一个地址空间的子程序（一般是开放网络中的一台"><meta itemprop="datePublished" content="2023-02-25T09:01:23+08:00" />
<meta itemprop="dateModified" content="2023-11-25T09:20:30+08:00" />
<meta itemprop="wordCount" content="3997">
<meta itemprop="keywords" content="golang,language," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="net/rpc"/>
<meta name="twitter:description" content="net/rpc 简介: 远程过程调用 (Remote Procedure Call，RPC) 是一种计算机通信协议。允许运行在一台计算机的程序调用另一个地址空间的子程序（一般是开放网络中的一台"/>
</head>
<body>
  
  <div class="header-container" style="background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('https://blog.yehaohui.com/images/background.jpg'); background-position: center; background-size: cover;">
  <div class="container">
  <nav class="header-nav navbar navbar-expand-md navbar-dark light-dark">
    <div class="header-logo navbar-brand">
      
        <a class="float-left" href="https://blog.yehaohui.com/zh-cn/">
      
        
        <img class="mr20 header-logo-image" src="https://blog.yehaohui.com/images/globe.svg" alt="logo">
        
        
          Yehh
         
      </a>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="nav-menu collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://blog.yehaohui.com/zh-cn/category/notes/">筆記</a>
              
            
          </li>
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://blog.yehaohui.com/zh-cn/category/life/">生活</a>
              
            
          </li>
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://blog.yehaohui.com/zh-cn/category/code/">编程</a>
              
            
          </li>
        
          <li class="nav-item">
            
              <a class="nav-link" href="https://blog.yehaohui.com/zh-cn/about/">关于</a>
            
          </li>
        
        
          
            <li class="nav-item">
              <a class="nav-link" href="https://blog.yehaohui.com/en/"><i class="fas fa-globe"></i> English</a>
            </li>
          
          
          
          
        
      </ul>
    </div>
  </nav>
</div>

<div class="container header-wrapper">
  <div class="row">
    <div class="col-lg-12">
      <div class="header-content">
        <h1 class="header-title">net/rpc</h1>
        <p class="header-date">作者：
          叶浩辉 /
        
        2023-02-25
          / 分类：
          <a href="https://blog.yehaohui.com/zh-cn/category/code/">code</a>
        </p>
        
        <div class="header-underline"></div>
        
          <div class="clearfix"></div>
          <p class="float-right header-tags">
              <i class="fas fa-tags" aria-hidden="true"></i>
              <a href="https://blog.yehaohui.com/zh-cn/tag/golang/">golang</a>, 
                <a href="https://blog.yehaohui.com/zh-cn/tag/language/">language</a>
          </p>
        
        

      </div>
    </div>
  </div>
</div>

  </div>
  <main>
<div class="container content">
  <article>
  <h2 id="netrpc">net/rpc</h2>
<h3 id="简介">简介:</h3>
<p>远程过程调用 (Remote Procedure Call，RPC) 是一种计算机通信协议。允许运行在一台计算机的程序调用另一个地址空间的子程序（一般是开放网络中的一台计算机），而程序员就像调用调用本地程序一样，无需额外做交互编程。RPC 是一种 CS (Client-Server) 架构的模式，通过发送请求-接收响应的方式进行信息的交互。</p>
<h3 id="基本用法">基本用法</h3>
<p>一般的的用法就是将定义好的符合要求的结构体在服务端注册上去，服务端监听一个socket来建立连接。</p>
<p>客户端通过拨号的方式来建立连接，然后通过客户端的client来调用服务端的方法。</p>
<p>定义结构和服务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">server</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Args</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">A</span><span class="p">,</span> <span class="nx">B</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Quotient</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Quo</span><span class="p">,</span> <span class="nx">Rem</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Arith</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Arith</span><span class="p">)</span> <span class="nf">Multiply</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">Args</span><span class="p">,</span> <span class="nx">reply</span> <span class="o">*</span><span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="nx">reply</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span> <span class="o">*</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Arith</span><span class="p">)</span> <span class="nf">Divide</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">Args</span><span class="p">,</span> <span class="nx">quo</span> <span class="o">*</span><span class="nx">Quotient</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;divide by zero&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">quo</span><span class="p">.</span><span class="nx">Quo</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span> <span class="o">/</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span>
</span></span><span class="line"><span class="cl">    <span class="nx">quo</span><span class="p">.</span><span class="nx">Rem</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span> <span class="o">%</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="服务端">服务端</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">arith</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Arith</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">rpc</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">arith</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">rpc</span><span class="p">.</span><span class="nf">HandleHTTP</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">l</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="s">&#34;:1234&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;listen error:&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="客户端">客户端</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rpc</span><span class="p">.</span><span class="nf">DialHTTP</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">serverAddress</span> <span class="o">+</span> <span class="s">&#34;:1234&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;dialing:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//同步
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">args</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">server</span><span class="p">.</span><span class="nx">Args</span><span class="p">{</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">reply</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="s">&#34;Arith.Multiply&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;arith error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Arith: %d*%d=%d&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//异步
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">quotient</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Quotient</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">divCall</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="s">&#34;Arith.Divide&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">quotient</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">replyCall</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">divCall</span><span class="p">.</span><span class="nx">Done</span>    <span class="c1">// will be equal to divCall
</span></span></span><span class="line"><span class="cl"><span class="c1">// check errors, print, etc.
</span></span></span></code></pre></div><p>在上面的例子里面比较难理解的是服务端的代码</p>
<p>在阅读完源码后发现其实就是监听端口，将tcp连接交给以及注册过rpc handler的http mux处理</p>
<h3 id="深入探究">深入探究</h3>
<blockquote>
<p>Only methods that satisfy these criteria will be made available for remote access; other methods will be ignored:</p>
</blockquote>
<blockquote>
<ul>
<li>the method&rsquo;s type is exported.</li>
<li>the method is exported.</li>
<li>the method has two arguments, both exported (or builtin) types.</li>
<li>the method&rsquo;s second argument is a pointer.</li>
<li>the method has return type error.</li>
<li>In effect, the method must look schematically like</li>
</ul>
</blockquote>
<blockquote>
<p>func (t *T) MethodName(argType T1, replyType *T2) error</p>
</blockquote>
<h4 id="服务端代码解析">服务端代码解析</h4>
<p>首先和net/http包一样有一个default的server</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">DefaultServer</span> <span class="p">=</span> <span class="nf">NewServer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Request is a header written before every RPC call. It is used internally
</span></span></span><span class="line"><span class="cl"><span class="c1">// but documented here as an aid to debugging, such as when analyzing
</span></span></span><span class="line"><span class="cl"><span class="c1">// network traffic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Request</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ServiceMethod</span> <span class="kt">string</span>   <span class="c1">// format: &#34;Service.Method&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Seq</span>           <span class="kt">uint64</span>   <span class="c1">// sequence number chosen by client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">next</span>          <span class="o">*</span><span class="nx">Request</span> <span class="c1">// for free list in Server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Response is a header written before every RPC return. It is used internally
</span></span></span><span class="line"><span class="cl"><span class="c1">// but documented here as an aid to debugging, such as when analyzing
</span></span></span><span class="line"><span class="cl"><span class="c1">// network traffic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Response</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ServiceMethod</span> <span class="kt">string</span>       <span class="c1">// echoes that of the Request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Seq</span>           <span class="kt">uint64</span>    <span class="c1">// echoes that of the request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Error</span>         <span class="kt">string</span>    <span class="c1">// error, if any.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">next</span>          <span class="o">*</span><span class="nx">Response</span> <span class="c1">// for free list in Server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//核心server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Server</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">serviceMap</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>   <span class="c1">// map[string]*service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">reqLock</span>    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span> <span class="c1">// protects freeReq
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">freeReq</span>    <span class="o">*</span><span class="nx">Request</span>
</span></span><span class="line"><span class="cl">	<span class="nx">respLock</span>   <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span> <span class="c1">// protects freeResp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">freeResp</span>   <span class="o">*</span><span class="nx">Response</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//内部的服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">service</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">name</span>   <span class="kt">string</span>                 <span class="c1">// name of service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rcvr</span>   <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span>          <span class="c1">// receiver of methods for the service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">typ</span>    <span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span>           <span class="c1">// type of the receiver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">method</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">methodType</span> <span class="c1">// registered methods
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 用来编解码并读取和发送的核心结构，可以自定义
</span></span></span><span class="line"><span class="cl"><span class="c1">// A ServerCodec implements reading of RPC requests and writing of
</span></span></span><span class="line"><span class="cl"><span class="c1">// RPC responses for the server side of an RPC session.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The server calls ReadRequestHeader and ReadRequestBody in pairs
</span></span></span><span class="line"><span class="cl"><span class="c1">// to read requests from the connection, and it calls WriteResponse to
</span></span></span><span class="line"><span class="cl"><span class="c1">// write a response back. The server calls Close when finished with the
</span></span></span><span class="line"><span class="cl"><span class="c1">// connection. ReadRequestBody may be called with a nil
</span></span></span><span class="line"><span class="cl"><span class="c1">// argument to force the body of the request to be read and discarded.
</span></span></span><span class="line"><span class="cl"><span class="c1">// See NewClient&#39;s comment for information about concurrent access.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ServerCodec</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ReadRequestHeader</span><span class="p">(</span><span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ReadRequestBody</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">WriteResponse</span><span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">any</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Close can be called multiple times and must be idempotent.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Close</span><span class="p">()</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>然后一般都是先register</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">rcvr</span> <span class="nx">any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">DefaultServer</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">rcvr</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            <span class="p">|</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">rcvr</span> <span class="nx">any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">server</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nx">rcvr</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="c1">//注册结构到server中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">register</span><span class="p">(</span><span class="nx">rcvr</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">useName</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">typ</span> <span class="p">=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">rcvr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">rcvr</span> <span class="p">=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">rcvr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//名字用来隔离不同结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">sname</span> <span class="o">:=</span> <span class="nx">name</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">useName</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//如果没给名字就用结构体的名字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">sname</span> <span class="p">=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">Indirect</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">rcvr</span><span class="p">).</span><span class="nf">Type</span><span class="p">().</span><span class="nf">Name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">sname</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span> <span class="o">:=</span> <span class="s">&#34;rpc.Register: no service name for type &#34;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">typ</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">useName</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">token</span><span class="p">.</span><span class="nf">IsExported</span><span class="p">(</span><span class="nx">sname</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//如果用结构体名字但是结构体名字不可导出也不行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">s</span> <span class="o">:=</span> <span class="s">&#34;rpc.Register: type &#34;</span> <span class="o">+</span> <span class="nx">sname</span> <span class="o">+</span> <span class="s">&#34; is not exported&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">name</span> <span class="p">=</span> <span class="nx">sname</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Install the methods
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nx">method</span> <span class="p">=</span> <span class="nf">suitableMethods</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">typ</span><span class="p">,</span> <span class="nx">logRegisterError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">str</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// To help the user, see if a pointer receiver would work.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">method</span> <span class="o">:=</span> <span class="nf">suitableMethods</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">PointerTo</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">typ</span><span class="p">),</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">str</span> <span class="p">=</span> <span class="s">&#34;rpc.Register: type &#34;</span> <span class="o">+</span> <span class="nx">sname</span> <span class="o">+</span> <span class="s">&#34; has no exported methods of suitable type (hint: pass a pointer to value of that type)&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">str</span> <span class="p">=</span> <span class="s">&#34;rpc.Register: type &#34;</span> <span class="o">+</span> <span class="nx">sname</span> <span class="o">+</span> <span class="s">&#34; has no exported methods of suitable type&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dup</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">serviceMap</span><span class="p">.</span><span class="nf">LoadOrStore</span><span class="p">(</span><span class="nx">sname</span><span class="p">,</span> <span class="nx">s</span><span class="p">);</span> <span class="nx">dup</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;rpc: service already defined: &#34;</span> <span class="o">+</span> <span class="nx">sname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              
</span></span><span class="line"><span class="cl">                <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="c1">// suitableMethods returns suitable Rpc methods of typ. It will log
</span></span></span><span class="line"><span class="cl"><span class="c1">// errors if logErr is true.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">suitableMethods</span><span class="p">(</span><span class="nx">typ</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span> <span class="nx">logErr</span> <span class="kt">bool</span><span class="p">)</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">methodType</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">methods</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">methodType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">m</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">m</span> <span class="p">&lt;</span> <span class="nx">typ</span><span class="p">.</span><span class="nf">NumMethod</span><span class="p">();</span> <span class="nx">m</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历所有方法,根据上面的法则来过滤函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//1. 必须可导出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//2. 需要有三个参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//3. 第一个需要是导出或内置类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//4. 第二个需要是指针类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//5. 需要有一个返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//6. 返回值需要是error类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">method</span> <span class="o">:=</span> <span class="nx">typ</span><span class="p">.</span><span class="nf">Method</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mtype</span> <span class="o">:=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">Type</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mname</span> <span class="o">:=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">Name</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Method must be exported.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">method</span><span class="p">.</span><span class="nf">IsExported</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Method needs three ins: receiver, *args, *reply.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">mtype</span><span class="p">.</span><span class="nf">NumIn</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">3</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">logErr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;rpc.Register: method %q has %d input parameters; needs exactly three\n&#34;</span><span class="p">,</span> <span class="nx">mname</span><span class="p">,</span> <span class="nx">mtype</span><span class="p">.</span><span class="nf">NumIn</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// First arg need not be a pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">argType</span> <span class="o">:=</span> <span class="nx">mtype</span><span class="p">.</span><span class="nf">In</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nf">isExportedOrBuiltinType</span><span class="p">(</span><span class="nx">argType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">logErr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;rpc.Register: argument type of method %q is not exported: %q\n&#34;</span><span class="p">,</span> <span class="nx">mname</span><span class="p">,</span> <span class="nx">argType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Second arg must be a pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">replyType</span> <span class="o">:=</span> <span class="nx">mtype</span><span class="p">.</span><span class="nf">In</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">replyType</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">logErr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;rpc.Register: reply type of method %q is not a pointer: %q\n&#34;</span><span class="p">,</span> <span class="nx">mname</span><span class="p">,</span> <span class="nx">replyType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Reply type must be exported.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nf">isExportedOrBuiltinType</span><span class="p">(</span><span class="nx">replyType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">logErr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;rpc.Register: reply type of method %q is not exported: %q\n&#34;</span><span class="p">,</span> <span class="nx">mname</span><span class="p">,</span> <span class="nx">replyType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Method needs one out.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">mtype</span><span class="p">.</span><span class="nf">NumOut</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">logErr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;rpc.Register: method %q has %d output parameters; needs exactly one\n&#34;</span><span class="p">,</span> <span class="nx">mname</span><span class="p">,</span> <span class="nx">mtype</span><span class="p">.</span><span class="nf">NumOut</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// The return type of the method must be error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">returnType</span> <span class="o">:=</span> <span class="nx">mtype</span><span class="p">.</span><span class="nf">Out</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">returnType</span> <span class="o">!=</span> <span class="nx">typeOfError</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">logErr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;rpc.Register: return type of method %q is %q, must be error\n&#34;</span><span class="p">,</span> <span class="nx">mname</span><span class="p">,</span> <span class="nx">returnType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">methods</span><span class="p">[</span><span class="nx">mname</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">methodType</span><span class="p">{</span><span class="nx">method</span><span class="p">:</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">ArgType</span><span class="p">:</span> <span class="nx">argType</span><span class="p">,</span> <span class="nx">ReplyType</span><span class="p">:</span> <span class="nx">replyType</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">methods</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>接下来就是hijack http连接，具体来说就是把server注册到http的mux里面，由于server实现了ServeHTTP的所以是可以做到的。</p>
<p>介绍http的CONNECT头部：</p>
<p><a href="https://joji.me/zh-cn/blog/the-http-connect-tunnel/">理解HTTP CONNECT通道</a></p>
<p>一般来说是用来在代理服务器建立一条client-&gt;real server的一条通道，在这里应该就是建立rpc的tcp连接。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ServeHTTP implements an http.Handler that answers RPC requests.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">!=</span> <span class="s">&#34;CONNECT&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;text/plain; charset=utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusMethodNotAllowed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">io</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;405 must CONNECT\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">conn</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.(</span><span class="nx">http</span><span class="p">.</span><span class="nx">Hijacker</span><span class="p">).</span><span class="nf">Hijack</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;rpc hijacking &#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">RemoteAddr</span><span class="p">,</span> <span class="s">&#34;: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//返回连接建立成功的消息，客户端之后可以开始发送rpc请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">io</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="s">&#34;HTTP/1.0 &#34;</span><span class="o">+</span><span class="nx">connected</span><span class="o">+</span><span class="s">&#34;\n\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">server</span><span class="p">.</span><span class="nf">ServeConn</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HandleHTTP registers an HTTP handler for RPC messages on rpcPath,
</span></span></span><span class="line"><span class="cl"><span class="c1">// and a debugging handler on debugPath.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It is still necessary to invoke http.Serve(), typically in a go statement.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">HandleHTTP</span><span class="p">(</span><span class="nx">rpcPath</span><span class="p">,</span> <span class="nx">debugPath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="nx">rpcPath</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="nx">debugPath</span><span class="p">,</span> <span class="nx">debugHTTP</span><span class="p">{</span><span class="nx">server</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//重点看下面两个函数就是核心逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ServeConn runs the server on a single connection.
</span></span></span><span class="line"><span class="cl"><span class="c1">// ServeConn blocks, serving the connection until the client hangs up.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The caller typically invokes ServeConn in a go statement.
</span></span></span><span class="line"><span class="cl"><span class="c1">// ServeConn uses the gob wire format (see package gob) on the
</span></span></span><span class="line"><span class="cl"><span class="c1">// connection. To use an alternate codec, use ServeCodec.
</span></span></span><span class="line"><span class="cl"><span class="c1">// See NewClient&#39;s comment for information about concurrent access.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">ServeConn</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ReadWriteCloser</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">buf</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">srv</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">gobServerCodec</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rwc</span><span class="p">:</span>    <span class="nx">conn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dec</span><span class="p">:</span>    <span class="nx">gob</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">conn</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">enc</span><span class="p">:</span>    <span class="nx">gob</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">encBuf</span><span class="p">:</span> <span class="nx">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">server</span><span class="p">.</span><span class="nf">ServeCodec</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ServeCodec is like ServeConn but uses the specified codec to
</span></span></span><span class="line"><span class="cl"><span class="c1">// decode requests and encode responses.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">ServeCodec</span><span class="p">(</span><span class="nx">codec</span> <span class="nx">ServerCodec</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//sending 并发写锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">sending</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">service</span><span class="p">,</span> <span class="nx">mtype</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">argv</span><span class="p">,</span> <span class="nx">replyv</span><span class="p">,</span> <span class="nx">keepReading</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">readRequest</span><span class="p">(</span><span class="nx">codec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">debugLog</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;rpc:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">keepReading</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// send a response if we actually managed to read a header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">req</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//sendResponse就是靠sending锁来控制并发，把reply和resp（err 如果有）写进去并回收resp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">server</span><span class="p">.</span><span class="nf">sendResponse</span><span class="p">(</span><span class="nx">sending</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">invalidRequest</span><span class="p">,</span> <span class="nx">codec</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//回收此次req
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">server</span><span class="p">.</span><span class="nf">freeRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//call 其实就是通过反射调用函数把运算值弄出来然后sendResponse
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">go</span> <span class="nx">service</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">sending</span><span class="p">,</span> <span class="nx">wg</span><span class="p">,</span> <span class="nx">mtype</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">argv</span><span class="p">,</span> <span class="nx">replyv</span><span class="p">,</span> <span class="nx">codec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// We&#39;ve seen that there are no more requests.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Wait for responses to be sent before closing codec.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">codec</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>server读取request的相关函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">readRequest</span><span class="p">(</span><span class="nx">codec</span> <span class="nx">ServerCodec</span><span class="p">)</span> <span class="p">(</span><span class="nx">service</span> <span class="o">*</span><span class="nx">service</span><span class="p">,</span> <span class="nx">mtype</span> <span class="o">*</span><span class="nx">methodType</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">argv</span><span class="p">,</span> <span class="nx">replyv</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="nx">keepReading</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">service</span><span class="p">,</span> <span class="nx">mtype</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">keepReading</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">readRequestHeader</span><span class="p">(</span><span class="nx">codec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">keepReading</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// discard body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">codec</span><span class="p">.</span><span class="nf">ReadRequestBody</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Decode the argument value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">argIsValue</span> <span class="o">:=</span> <span class="kc">false</span> <span class="c1">// if true, need to indirect before calling.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">mtype</span><span class="p">.</span><span class="nx">ArgType</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="o">==</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">argv</span> <span class="p">=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">mtype</span><span class="p">.</span><span class="nx">ArgType</span><span class="p">.</span><span class="nf">Elem</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">argv</span> <span class="p">=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">mtype</span><span class="p">.</span><span class="nx">ArgType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">argIsValue</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// argv guaranteed to be a pointer now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">codec</span><span class="p">.</span><span class="nf">ReadRequestBody</span><span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nf">Interface</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">argIsValue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">argv</span> <span class="p">=</span> <span class="nx">argv</span><span class="p">.</span><span class="nf">Elem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">replyv</span> <span class="p">=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">mtype</span><span class="p">.</span><span class="nx">ReplyType</span><span class="p">.</span><span class="nf">Elem</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">mtype</span><span class="p">.</span><span class="nx">ReplyType</span><span class="p">.</span><span class="nf">Elem</span><span class="p">().</span><span class="nf">Kind</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Map</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">replyv</span><span class="p">.</span><span class="nf">Elem</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">MakeMap</span><span class="p">(</span><span class="nx">mtype</span><span class="p">.</span><span class="nx">ReplyType</span><span class="p">.</span><span class="nf">Elem</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Slice</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">replyv</span><span class="p">.</span><span class="nf">Elem</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">MakeSlice</span><span class="p">(</span><span class="nx">mtype</span><span class="p">.</span><span class="nx">ReplyType</span><span class="p">.</span><span class="nf">Elem</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">readRequestHeader</span><span class="p">(</span><span class="nx">codec</span> <span class="nx">ServerCodec</span><span class="p">)</span> <span class="p">(</span><span class="nx">svc</span> <span class="o">*</span><span class="nx">service</span><span class="p">,</span> <span class="nx">mtype</span> <span class="o">*</span><span class="nx">methodType</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">keepReading</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Grab the request header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 这个request是以链表形式存在server的，然后被释放的可以加锁加到头节点复用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">req</span> <span class="p">=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">getRequest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 根据不同实现获取头部信息，包括method的信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">codec</span><span class="p">.</span><span class="nf">ReadRequestHeader</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">req</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="o">||</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ErrUnexpectedEOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;rpc: server cannot decode request: &#34;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// We read the header successfully. If we see an error now,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// we can still recover and move on to the next request.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//已经读到一个request，后面的错误可能只是找不到对应的方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">keepReading</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">dot</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">LastIndex</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">ServiceMethod</span><span class="p">,</span> <span class="s">&#34;.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">dot</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;rpc: service/method request ill-formed: &#34;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ServiceMethod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">serviceName</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ServiceMethod</span><span class="p">[:</span><span class="nx">dot</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nx">methodName</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ServiceMethod</span><span class="p">[</span><span class="nx">dot</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Look up the request.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">svci</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">serviceMap</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">serviceName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;rpc: can&#39;t find service &#34;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ServiceMethod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">svc</span> <span class="p">=</span> <span class="nx">svci</span><span class="p">.(</span><span class="o">*</span><span class="nx">service</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mtype</span> <span class="p">=</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">method</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">mtype</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;rpc: can&#39;t find method &#34;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ServiceMethod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="客户端代码解析">客户端代码解析</h4>
<p>核心类型</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//call用来表达一个rpc调用，同步和异步都可以
</span></span></span><span class="line"><span class="cl"><span class="c1">// Call represents an active RPC.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Call</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ServiceMethod</span> <span class="kt">string</span>     <span class="c1">// The name of the service and method to call.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Args</span>          <span class="nx">any</span>        <span class="c1">// The argument to the function (*struct).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Reply</span>         <span class="nx">any</span>        <span class="c1">// The reply from the function (*struct).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Error</span>         <span class="kt">error</span>      <span class="c1">// After completion, the error status.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Done</span>          <span class="kd">chan</span> <span class="o">*</span><span class="nx">Call</span> <span class="c1">// Receives *Call when Go is complete.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Client represents an RPC Client.
</span></span></span><span class="line"><span class="cl"><span class="c1">// There may be multiple outstanding Calls associated
</span></span></span><span class="line"><span class="cl"><span class="c1">// with a single Client, and a Client may be used by
</span></span></span><span class="line"><span class="cl"><span class="c1">// multiple goroutines simultaneously.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Client</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">codec</span> <span class="nx">ClientCodec</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="nx">reqMutex</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span> <span class="c1">// protects following
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">request</span>  <span class="nx">Request</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">mutex</span>    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span> <span class="c1">// protects following
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">seq</span>      <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pending</span>  <span class="kd">map</span><span class="p">[</span><span class="kt">uint64</span><span class="p">]</span><span class="o">*</span><span class="nx">Call</span> <span class="c1">//pending是用来等待写入但没有回应的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">closing</span>  <span class="kt">bool</span> <span class="c1">// user has called Close
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">shutdown</span> <span class="kt">bool</span> <span class="c1">// server has told us to stop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">其实和服务端的类似</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ClientCodec</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">WriteRequest</span><span class="p">(</span><span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">any</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ReadResponseHeader</span><span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ReadResponseBody</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">Close</span><span class="p">()</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>核心函数</p>
<p>rpc.DialHTTP(network, address string)-&gt;(把DialHTTPPath的path设为默认的路径)</p>
<p>rpc.DialHTTPPath(network, address, path string)-&gt;</p>
<p>rpc.NewClient(conn io.ReadWriteCloser)-&gt;</p>
<p>rpc.Client.Call()</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// DialHTTPPath connects to an HTTP RPC server
</span></span></span><span class="line"><span class="cl"><span class="c1">// at the specified network address and path.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">DialHTTPPath</span><span class="p">(</span><span class="nx">network</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">network</span><span class="p">,</span> <span class="nx">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//conn是一个tcp连接，通过http的connect头部来建立rpc连接（这里和服务端配合利用http建立tcp）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">io</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="s">&#34;CONNECT &#34;</span><span class="o">+</span><span class="nx">path</span><span class="o">+</span><span class="s">&#34; HTTP/1.0\n\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Require successful HTTP response
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// before switching to RPC protocol.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ReadResponse</span><span class="p">(</span><span class="nx">bufio</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">conn</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span><span class="nx">Method</span><span class="p">:</span> <span class="s">&#34;CONNECT&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Status</span> <span class="o">==</span> <span class="nx">connected</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//成功建立
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nf">NewClient</span><span class="p">(</span><span class="nx">conn</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//连接失败或者返回的不是connect之类的错误处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>建立客户端连接的核心函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//使用默认的god编码
</span></span></span><span class="line"><span class="cl"><span class="c1">//要注意的是一个client可能会有并发的使用情况，所以在真正io的时候需要并发控制（加锁·11）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewClient</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ReadWriteCloser</span><span class="p">)</span> <span class="o">*</span><span class="nx">Client</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">encBuf</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">gobClientCodec</span><span class="p">{</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">gob</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">conn</span><span class="p">),</span> <span class="nx">gob</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="nx">encBuf</span><span class="p">),</span> <span class="nx">encBuf</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">NewClientWithCodec</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// NewClientWithCodec is like NewClient but uses the specified
</span></span></span><span class="line"><span class="cl"><span class="c1">// codec to encode requests and decode responses.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewClientWithCodec</span><span class="p">(</span><span class="nx">codec</span> <span class="nx">ClientCodec</span><span class="p">)</span> <span class="o">*</span><span class="nx">Client</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Client</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">codec</span><span class="p">:</span>   <span class="nx">codec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pending</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">uint64</span><span class="p">]</span><span class="o">*</span><span class="nx">Call</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//开一个协程处理返回的结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">client</span><span class="p">.</span><span class="nf">input</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">client</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>看client同步和异步调用的核心函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//同步
</span></span></span><span class="line"><span class="cl"><span class="c1">//就是等异步的go完成，所以重点还是在go这里
</span></span></span><span class="line"><span class="cl"><span class="c1">// Call invokes the named function, waits for it to complete, and returns its error status.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Call</span><span class="p">(</span><span class="nx">serviceMethod</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">reply</span> <span class="nx">any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">call</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">client</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="nx">serviceMethod</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">reply</span><span class="p">,</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">Call</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="nx">Done</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">call</span><span class="p">.</span><span class="nx">Error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//异步，其实就是把结构体初始化，还是得看client.send
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Go</span><span class="p">(</span><span class="nx">serviceMethod</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">reply</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">done</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">Call</span><span class="p">)</span> <span class="o">*</span><span class="nx">Call</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">call</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Call</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">call</span><span class="p">.</span><span class="nx">ServiceMethod</span> <span class="p">=</span> <span class="nx">serviceMethod</span>
</span></span><span class="line"><span class="cl">	<span class="nx">call</span><span class="p">.</span><span class="nx">Args</span> <span class="p">=</span> <span class="nx">args</span>
</span></span><span class="line"><span class="cl">	<span class="nx">call</span><span class="p">.</span><span class="nx">Reply</span> <span class="p">=</span> <span class="nx">reply</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">done</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">done</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">Call</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="c1">// buffered.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If caller passes done != nil, it must arrange that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// done has enough buffer for the number of simultaneous
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// RPCs that will be using that channel. If the channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// is totally unbuffered, it&#39;s best not to run at all.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Panic</span><span class="p">(</span><span class="s">&#34;rpc: done channel is unbuffered&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">call</span><span class="p">.</span><span class="nx">Done</span> <span class="p">=</span> <span class="nx">done</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">call</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">call</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">send</span><span class="p">(</span><span class="nx">call</span> <span class="o">*</span><span class="nx">Call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nx">reqMutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nx">reqMutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Register this call.唯一序列号 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">client</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">client</span><span class="p">.</span><span class="nx">shutdown</span> <span class="o">||</span> <span class="nx">client</span><span class="p">.</span><span class="nx">closing</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">call</span><span class="p">.</span><span class="nx">Error</span> <span class="p">=</span> <span class="nx">ErrShutdown</span>
</span></span><span class="line"><span class="cl">		<span class="nx">call</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">seq</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">seq</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nx">seq</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nx">pending</span><span class="p">[</span><span class="nx">seq</span><span class="p">]</span> <span class="p">=</span> <span class="nx">call</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//这里比较特别req不像服务端那样是链表，而是一个全局的，所以需要加锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Encode and send the request.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">Seq</span> <span class="p">=</span> <span class="nx">seq</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">ServiceMethod</span> <span class="p">=</span> <span class="nx">call</span><span class="p">.</span><span class="nx">ServiceMethod</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">codec</span><span class="p">.</span><span class="nf">WriteRequest</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">,</span> <span class="nx">call</span><span class="p">.</span><span class="nx">Args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//写完之后就可以回收req了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//如果写失败就删掉pending里面的call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">call</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">pending</span><span class="p">[</span><span class="nx">seq</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nb">delete</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">pending</span><span class="p">,</span> <span class="nx">seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">call</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">call</span><span class="p">.</span><span class="nx">Error</span> <span class="p">=</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="nx">call</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>最后就是最重要的处理response的后台input函数了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">input</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">response</span> <span class="nx">Response</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">response</span> <span class="p">=</span> <span class="nx">Response</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">codec</span><span class="p">.</span><span class="nf">ReadResponseHeader</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//服务端 出错了，需要关闭
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//先去找对应的call，并且删除因为已经接受到回复了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">seq</span> <span class="o">:=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">Seq</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">call</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">pending</span><span class="p">[</span><span class="nx">seq</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nb">delete</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">pending</span><span class="p">,</span> <span class="nx">seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">call</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//由于写入请求的失败，导致pending map里面其实已经没有了对应的call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//但是又写了东西，所以这里需要读取body，但是没有call可以给
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// We&#39;ve got no pending call. That usually means that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// WriteRequest partially failed, and call was already
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// removed; response is a server telling us about an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// error reading request body. We should still attempt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// to read error body, but there&#39;s no one to give it to.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">codec</span><span class="p">.</span><span class="nf">ReadResponseBody</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;reading error body: &#34;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//这里也不需要done，在写入请求的时候就已经会自动调用done了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">case</span> <span class="nx">response</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//远程调用出错
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// We&#39;ve got an error response. Give this to the request;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// any subsequent requests will get the ReadResponseBody
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// error if there is one.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">call</span><span class="p">.</span><span class="nx">Error</span> <span class="p">=</span> <span class="nf">ServerError</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">Error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">codec</span><span class="p">.</span><span class="nf">ReadResponseBody</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;reading error body: &#34;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">call</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//ok
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">codec</span><span class="p">.</span><span class="nf">ReadResponseBody</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nx">Reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">call</span><span class="p">.</span><span class="nx">Error</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;reading body &#34;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">call</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Terminate pending calls.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">client</span><span class="p">.</span><span class="nx">reqMutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nx">shutdown</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="nx">closing</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">closing</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">closing</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="p">=</span> <span class="nx">ErrShutdown</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ErrUnexpectedEOF</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">call</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">client</span><span class="p">.</span><span class="nx">pending</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">call</span><span class="p">.</span><span class="nx">Error</span> <span class="p">=</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="nx">call</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nx">reqMutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">debugLog</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">closing</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;rpc: client protocol error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>到这里就差不多结束了</p>
<h3 id="参考">参考</h3>
<p><a href="https://cloud.tencent.com/developer/article/1662215">Go net/rpc 包的深度解读和学习</a></p>
<p><a href="https://books.studygolang.com/go-rpc-programming-guide/">rpcx</a></p>
<p><a href="https://www.bookstack.cn/read/go-rpc-programming-guide/part1-gorpc.md">rpc使用</a></p>
<h2 id="mime">mime</h2>
<p><a href="https://www.cnblogs.com/wanghui-garcia/p/10402796.html">go标准库的学习-mime/multipart</a></p>

  </article>

  
  
    
    <div class="author-card">
    <div class="underline"></div>
    <div class="author-box">
      <div class="author-image"><a href="/zh-cn/zh-cn/about/"><img src="/images/yehh.png" alt="叶浩辉" /></a></div>
      <div class="author-content">
      <p class="author-title">作者</p>
      <p class="author-name">叶浩辉</p>
      <p class="author-desc">一起分享与进步吧。</p>
      </div>
    </div>
  </div>
    
  
  


</div>

  </main><div class="footer gradient-2">
  <div class="container footer-container ">
    <div class="row">
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        <div class="footer-title">网站地图</div>
        <ul class="list-unstyled">
            
              
                <li><a href="https://blog.yehaohui.com/zh-cn/tags/">标签</a></li>
              
              
                <li><a href="https://blog.yehaohui.com/zh-cn/categories/">分类</a></li>
              
            
            
            
            <li><a rel="alternate" type="application/rss&#43;xml" href="https://blog.yehaohui.com/zh-cn/index.xml"><i class="fas fa-rss-square"></i> RSS订阅</a></li>
            
            
            
        </ul>
      </div>
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        
        <div class="footer-title">社群</div>
        <ul class="list-unstyled">
          
          <li><a href="https://github.com/haohui03" rel="noopener" target="_blank">GitHub</a></li>
          
        </ul>
        
      </div>
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        
        <div class="footer-title">友链</div>
        <ul class="list-unstyled">
          
          <li><a href="https://www.yehaohui.com/" rel="noopener" target="_blank">关于我</a></li>
          
        </ul>
        
      </div> 
      <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
        <p class="pull-right text-right">
          <small><em>Proudly powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo</a></em></small><br/>
          <small><em>Theme - <a href="https://github.com/shaform/hugo-theme-den" rel="noopener" target="_blank">Den</a></em></small><br/>
          <small>
            &copy; 
            yehh
            
              2017 -
            2023
          </small>
          
        </p>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

</body>
</html>
